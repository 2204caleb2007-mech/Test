<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Analyzer - Live Weather & Hazards</title>
    <link rel="stylesheet" href="cta.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f8fa;
            color: #14171a;
            line-height: 1.6;
            scroll-behavior: smooth;
            margin: 0;
            padding: 0;
        }
        
        .hero-section {
            position: relative;
            width: 100%;
            height: 82vh;
            overflow: hidden;
        }
        
        .video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2;
        }
        
        .hero-content {
            position: relative;
            z-index: 3;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 1rem;
        }
        
        .severity-high {
            background-color: #ffcccc;
            color: #cc0000;
        }
        
        .severity-medium {
            background-color: #fff2cc;
            color: #b38600;
        }
        
        .severity-low {
            background-color: #d9ead3;
            color: #38761d;
        }
        
        .weather-severity-high {
            border-left-color: #cc0000;
        }
        
        .weather-severity-medium {
            border-left-color: #b38600;
        }
        
        .weather-severity-low {
            border-left-color: #38761d;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background-color: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0f4c75;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom marker styles for Esri */
        .esri-view-root .custom-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .marker-high {
            background-color: #ff0000;
        }
        
        .marker-medium {
            background-color: #ffcc00;
        }
        
        .marker-low {
            background-color: #00cc00;
        }
        
        /* Custom info panel at bottom left */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            max-width: 350px;
            transition: all 0.3s ease;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        
        /* Original color scheme classes */
        .btn {
            display: inline-block;
            background-color: #1da1f2;
            color: white;
            padding: 12px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #0d8bd9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 161, 242, 0.3);
        }
        
        .btn-ocean {
            background-color: #0f4c75;
        }
        
        .btn-ocean:hover {
            background-color: #0a3a5a;
        }
        
        .btn-report {
            background-color: #0f4c75;
        }
        
        .btn-report:hover {
            background-color: #0a3a5a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 76, 117, 0.3);
        }
        
        .section-title {
            text-align: center;
            color: #0f4c75;
            font-size: 2rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .feature-card {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: #1da1f2;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
        }
        
        .ocean-hazards {
            background-color: white;
            padding: 3rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 4rem;
            width: 100%;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .hazard-card {
            background-color: #f5f8fa;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #0f4c75;
        }
        
        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            position: relative;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .section-title {
                font-size: 1.8rem;
            }
            
            .ocean-hazards {
                padding: 1.5rem;
            }
            
            .map-container {
                height: 400px;
            }
            
            .info-panel {
                max-width: 280px;
                padding: 1rem;
                bottom: 10px;
                left: 10px;
            }
            
            .hero-content h1 {
                font-size: 2.5rem;
            }
            
            .hero-content p {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 480px) {
            .section-title {
                font-size: 1.5rem;
            }
            
            .map-container {
                height: 350px;
            }
            
            .info-panel {
                max-width: 250px;
                padding: 0.8rem;
            }
            
            .hero-content h1 {
                font-size: 2rem;
            }
            
            .hero-content p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header and Navigation will be loaded here by JavaScript -->
    <div id="header-container"></div>
    
    <section class="hero-section" id="home">
        <!-- YouTube video as background -->
        <div class="video-background">
    <iframe 
        src="https://www.youtube.com/embed/8U_nLVItqdw?autoplay=1&mute=1&controls=0&loop=1&playlist=8U_nLVItqdw&modestbranding=1&rel=0" 
        frameborder="0" 
        allow="autoplay; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen
        style="width: 100%; height: 100%; object-fit: cover;">
    </iframe>
</div>
        <div class="video-overlay"></div>
        <div class="hero-content container mx-auto px-4 md:px-6">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-6 text-white drop-shadow-lg">Monitor Ocean Hazards Through Social Media</h1>
            <p class="text-lg md:text-xl max-w-3xl mx-auto mb-10 text-white drop-shadow-md">Track and analyze ocean-related hazards extracted from social media platforms. Get real-time alerts, analyze trends, and make data-driven decisions for coastal safety.</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <a href="#hazards" class="btn text-center" id="startMonitoringBtn">Start Monitoring</a>
                <a href="Recentposts.html#register-complaint" class="btn btn-report text-center" id="reportHazardBtn">Report Hazard!</a>
            </div>
        </div>
    </section>
    
    <section id="features" class="container mx-auto px-4 md:px-6 py-16">
        <h2 class="section-title my-10">Key Features</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-water"></i></div>
                <h3 class="text-xl font-bold mb-4 text-gray-900">Real-time Hazard Detection</h3>
                <p class="text-gray-700">Automatically extract and analyze ocean hazard reports from social media platforms in real-time. Get instant alerts for rip currents, algal blooms, tsunamis, and more.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                <h3 class="text-xl font-bold mb-4 text-gray-900">Trend Analysis & Predictions</h3>
                <p class="text-gray-700">Identify patterns in ocean hazard occurrences and predict future risks based on historical data and environmental factors.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-bell"></i></div>
                <h3 class="text-xl font-bold mb-4 text-gray-900">Custom Alert System</h3>
                <p class="text-gray-700">Set up personalized alerts for specific locations, hazard types, or severity levels to stay informed about relevant ocean threats.</p>
            </div>
        </div>
    </section>
    
    <section id="hazards" class="container mx-auto px-4 md:px-6 py-8">
        <h2 class="section-title my-10">
            Live Weather & Hazards Monitoring
            <span class="inline-flex items-center gap-2 bg-green-100 text-green-800 text-sm font-semibold ml-4 px-3 py-1 rounded-full">
                <span class="live-dot"></span>
                LIVE
            </span>
        </h2>
        <div class="ocean-hazards">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <button class="btn btn-ocean inline-flex items-center justify-center" id="refreshWeather">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Weather
                    </button>
                    <div class="relative">
                        <button class="btn inline-flex items-center" id="filterButton">
                            <i class="fas fa-filter mr-2"></i> Filter by Severity
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div class="absolute hidden bg-white shadow-xl rounded-lg mt-2 z-10 min-w-[160px]" id="filterDropdown">
                            <div class="filter-option active cursor-pointer px-4 py-3 hover:bg-gray-100 border-b border-gray-100" data-filter="all">All Severities</div>
                            <div class="filter-option cursor-pointer px-4 py-3 hover:bg-gray-100 border-b border-gray-100" data-filter="high">High Severity</div>
                            <div class="filter-option cursor-pointer px-4 py-3 hover:bg-gray-100 border-b border-gray-100" data-filter="medium">Medium Severity</div>
                            <div class="filter-option cursor-pointer px-4 py-3 hover:bg-gray-100" data-filter="low">Low Severity</div>
                        </div>
                    </div>
                </div>
                <div>
                    <input type="text" id="searchHazards" placeholder="Search locations..." class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto" style="padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                </div>
            </div>
            
            <div class="text-center text-gray-500 italic mb-6" id="lastUpdated">Last updated: Loading...</div>
            
            <div class="map-container">
                <div id="indiaMap" class="w-full h-full"></div>
                
                <!-- Info Panel (Bottom Left) -->
                <div id="infoPanel" class="info-panel hidden">
                    <div class="flex justify-between items-start mb-3">
                        <h3 id="infoCity" class="text-lg font-bold text-blue-900"></h3>
                        <span id="infoSeverity" class="text-xs font-bold px-2 py-1 rounded"></span>
                    </div>
                    <div class="flex items-center gap-3 mb-3">
                        <div id="infoIcon" class="text-3xl text-blue-500"></div>
                        <div>
                            <div id="infoTemp" class="text-xl font-bold text-blue-900"></div>
                            <div id="infoDesc" class="text-gray-600 text-sm"></div>
                        </div>
                    </div>
                    <div id="infoContent" class="text-gray-700 text-sm mb-3"></div>
                    <div class="grid grid-cols-2 gap-3 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-tint text-blue-400"></i>
                            <span id="infoHumidity"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-wind text-blue-400"></i>
                            <span id="infoWind"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-blue-400"></i>
                            <span id="infoRegion"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock text-blue-400"></i>
                            <span id="infoTime"></span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 text-right">
                        <span id="infoStatus" class="text-xs"></span>
                    </div>
                </div>
                
                <!-- Map Legend (Bottom Right) -->
                <div class="absolute bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 z-10">
                    <div class="font-bold text-blue-900 mb-2">Severity Legend</div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-sm">High Severity</span>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <span class="text-sm">Medium Severity</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-sm">Low Severity</span>
                    </div>
                </div>
            </div>
            
            <!-- Hidden weather data container -->
            <div id="weatherList" class="hidden">
                <div class="flex flex-col items-center justify-center p-8 text-gray-600">
                    <div class="spinner"></div>
                    <p>Loading live weather data for India...</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="cta">
    <div class="container mx-auto px-4 md:px-6 text-center">
        <h2 class="section-title" style="color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Ready to Enhance Coastal Safety Monitoring with us?</h2>
        <p>Join coastal authorities, researchers, and safety organizations using our platform to detect and respond to ocean hazards more effectively.</p>
        <a href="Recentposts.html" class="btn" id="joinUsBtn">Help us make changes!</a>
    </div>
</section>

<div id="floating-button-container"></div>
<div id="footer-container"></div>

    <script>
        // JavaScript function to load external HTML files
        function loadComponent(url, elementId) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById(elementId).innerHTML = data;
                    // Execute any scripts in the loaded content
                    const scripts = document.getElementById(elementId).getElementsByTagName('script');
                    for (let script of scripts) {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        document.head.appendChild(newScript);
                    }
                    
                    // IMPORTANT: Initialize header functionality if it's the header
                    if (elementId === 'header-container') {
                        // Call the initialization function after a short delay to ensure DOM is ready
                        setTimeout(() => {
                            if (window.initHeader) {
                                window.initHeader();
                            }
                        }, 100);
                    }
                })
                .catch(error => {
                    console.error(`Error loading ${url}:`, error);
                    document.getElementById(elementId).innerHTML = `<p>Error loading component from ${url}</p>`;
                });
        }

        // Load header and footer when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load the header/navigation
            loadComponent('navheader.html', 'header-container');
            
            // Load the footer
            loadComponent('footer.html', 'footer-container');

            // Load the floating button
            loadComponent('button.html', 'floating-button-container');
            
            // Initialize variables
            const refreshWeatherBtn = document.getElementById('refreshWeather');
            const filterButton = document.getElementById('filterButton');
            const filterDropdown = document.getElementById('filterDropdown');
            const filterOptions = document.querySelectorAll('.filter-option');
            const searchHazardsInput = document.getElementById('searchHazards');
            const lastUpdatedElement = document.getElementById('lastUpdated');
            const weatherList = document.getElementById('weatherList');
            const infoPanel = document.getElementById('infoPanel');

            // Esri map variables
            let map, view;
            let graphicsLayer;
            let currentWeatherData = [];
            let currentFilter = 'all';
            let currentSearch = '';
            let hoveredGraphic = null;

            // Indian cities to monitor with coordinates - Updated with Coimbatore and removed Thane
            const indianCities = [
                { name: "Mumbai", lat: 19.0760, lon: 72.8777, region: "Maharashtra" },
                { name: "Chennai", lat: 13.0827, lon: 80.2707, region: "Tamil Nadu" },
                { name: "Kolkata", lat: 22.5726, lon: 88.3639, region: "West Bengal" },
                { name: "Delhi", lat: 28.6139, lon: 77.2090, region: "Delhi" },
                { name: "Bangalore", lat: 12.9716, lon: 77.5946, region: "Karnataka" },
                { name: "Hyderabad", lat: 17.3850, lon: 78.4867, region: "Telangana" },
                { name: "Kochi", lat: 9.9312, lon: 76.2673, region: "Kerala" },
                { name: "Goa", lat: 15.2993, lon: 74.1240, region: "Goa" },
                { name: "Visakhapatnam", lat: 17.6868, lon: 83.2185, region: "Andhra Pradesh" },
                { name: "Puducherry", lat: 11.9416, lon: 79.8083, region: "Puducherry" },
                { name: "Jaipur", lat: 26.9124, lon: 75.7873, region: "Rajasthan" },
                { name: "Lucknow", lat: 26.8467, lon: 80.9462, region: "Uttar Pradesh" },
                { name: "Ahmedabad", lat: 23.0225, lon: 72.5714, region: "Gujarat" },
                { name: "Pune", lat: 18.5204, lon: 73.8567, region: "Maharashtra" },
                { name: "Surat", lat: 21.1702, lon: 72.8311, region: "Gujarat" },
                { name: "Kanpur", lat: 26.4499, lon: 80.3319, region: "Uttar Pradesh" },
                { name: "Nagpur", lat: 21.1458, lon: 79.0882, region: "Maharashtra" },
                { name: "Indore", lat: 22.7196, lon: 75.8577, region: "Madhya Pradesh" },
                { name: "Coimbatore", lat: 11.0168, lon: 76.9558, region: "Tamil Nadu" },
                { name: "Bhopal", lat: 23.2599, lon: 77.4126, region: "Madhya Pradesh" }
            ];

            // Initialize the Esri map
            async function initializeMap() {
                // Load the required ArcGIS modules
                require([
                    "esri/Map",
                    "esri/views/MapView",
                    "esri/layers/GraphicsLayer",
                    "esri/Graphic",
                    "esri/symbols/SimpleMarkerSymbol",
                    "esri/geometry/Point",
                    "esri/geometry/Extent"
                ], function(Map, MapView, GraphicsLayer, Graphic, SimpleMarkerSymbol, Point, Extent) {
                    
                    // Create a map
                    map = new Map({
                        basemap: "streets-navigation-vector"
                    });
                    
                    // Create a view with constraints to keep within India
                    view = new MapView({
                        container: "indiaMap",
                        map: map,
                        center: [78.9629, 20.5937], // India center
                        zoom: 5,
                        constraints: {
                            geometry: new Extent({
                                xmin: 68.1,  // Westernmost point of India
                                ymin: 6.7,   // Southernmost point of India
                                xmax: 97.4,  // Easternmost point of India
                                ymax: 37.1,  // Northernmost point of India
                                spatialReference: { wkid: 4326 }
                            }),
                            minZoom: 4,
                            maxZoom: 10
                        }
                    });
                    
                    // Prevent zooming out too far
                    view.watch('zoom', function(newZoom) {
                        if (newZoom < 4) {
                            view.zoom = 4;
                        }
                    });
                    
                    // Create a graphics layer for markers
                    graphicsLayer = new GraphicsLayer();
                    map.add(graphicsLayer);
                    
                    // Setup hover events
                    view.on("pointer-move", function(event) {
                        view.hitTest(event).then(function(response) {
                            if (response.results.length > 0) {
                                const graphic = response.results[0].graphic;
                                if (graphic && graphic.attributes && graphic.attributes.type === "weather") {
                                    showInfoPanel(graphic.attributes);
                                    hoveredGraphic = graphic;
                                } else {
                                    hideInfoPanel();
                                }
                            } else {
                                hideInfoPanel();
                            }
                        });
                    });
                    
                    // Hide panel when clicking on map
                    view.on("click", function() {
                        hideInfoPanel();
                    });
                    
                    // Update map after initialization
                    updateMapMarkers();
                });
            }

            // Function to fetch weather data from OpenWeatherMap API
            async function fetchWeatherData() {
                lastUpdatedElement.textContent = 'Last updated: Loading...';
                
                const apiKey = 'e9c0997a327ce0593760fa449e9a78a9'; // Free OpenWeatherMap API key
                const promises = indianCities.map(async (city) => {
                    try {
                        // Try to fetch from OpenWeatherMap
                        const response = await fetch(
                            `https://api.openweathermap.org/data/2.5/weather?lat=${city.lat}&lon=${city.lon}&appid=${apiKey}&units=metric`
                        );
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Determine severity based on weather conditions
                        let severity = "low";
                        let weatherType = "normal";
                        
                        // Check for severe weather conditions
                        if (data.weather[0].main === "Thunderstorm" || data.wind.speed > 10) {
                            severity = "high";
                            weatherType = "storm";
                        } else if (data.weather[0].main === "Rain" || data.weather[0].main === "Drizzle") {
                            severity = "medium";
                            weatherType = "rain";
                        } else if (data.main.temp > 35 || data.main.temp < 10) {
                            severity = "medium";
                            weatherType = "extreme_temp";
                        }
                        
                        // Check for coastal hazards for coastal cities
                        const coastalCities = ["Mumbai", "Chennai", "Kolkata", "Kochi", "Goa", "Visakhapatnam", "Puducherry"];
                        if (coastalCities.includes(city.name)) {
                            if (data.wind.speed > 8) {
                                severity = "high";
                                weatherType = "high_wind";
                            }
                            if (data.main.humidity > 85 && data.weather[0].main === "Rain") {
                                severity = "high";
                                weatherType = "heavy_rain";
                            }
                        }
                        
                        return {
                            id: city.name.toLowerCase().replace(/\s+/g, '-'),
                            title: `${city.name} Weather`,
                            content: `Current conditions: ${data.weather[0].description}. Temperature: ${Math.round(data.main.temp)}°C, Humidity: ${data.main.humidity}%`,
                            severity: severity,
                            location: `${city.name}, ${city.region}`,
                            timestamp: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
                            source: "openweathermap",
                            temperature: Math.round(data.main.temp),
                            humidity: data.main.humidity,
                            windSpeed: data.wind.speed,
                            weatherIcon: data.weather[0].icon,
                            weatherMain: data.weather[0].main,
                            weatherDescription: data.weather[0].description,
                            weatherType: weatherType,
                            isLive: true,
                            lat: city.lat,
                            lon: city.lon,
                            city: city.name,
                            region: city.region
                        };
                    } catch (error) {
                        console.error(`Error fetching weather for ${city.name}:`, error);
                        
                        // Fallback: Use mock data if API fails
                        const mockSeverities = ["low", "medium", "high"];
                        const mockWeatherTypes = ["normal", "rain", "storm", "high_wind", "extreme_temp"];
                        const randomSeverity = mockSeverities[Math.floor(Math.random() * mockSeverities.length)];
                        const randomWeatherType = mockWeatherTypes[Math.floor(Math.random() * mockWeatherTypes.length)];
                        
                        return {
                            id: city.name.toLowerCase().replace(/\s+/g, '-'),
                            title: `${city.name} Weather`,
                            content: `Live weather data temporarily unavailable. Last known: Moderate conditions.`,
                            severity: randomSeverity,
                            location: `${city.name}, ${city.region}`,
                            timestamp: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
                            source: "backup",
                            temperature: Math.floor(Math.random() * 15) + 25,
                            humidity: Math.floor(Math.random() * 30) + 50,
                            windSpeed: (Math.random() * 10).toFixed(1),
                            weatherIcon: "02d",
                            weatherMain: "Clouds",
                            weatherDescription: "Partly cloudy",
                            weatherType: randomWeatherType,
                            isLive: false,
                            lat: city.lat,
                            lon: city.lon,
                            city: city.name,
                            region: city.region
                        };
                    }
                });

                try {
                    const results = await Promise.all(promises);
                    currentWeatherData = results;
                    updateLastUpdatedTime();
                    updateMapMarkers();
                } catch (error) {
                    console.error("Error fetching all weather data:", error);
                    showError("Unable to fetch live weather data. Please try again.");
                }
            }

            // Function to update last updated time
            function updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true 
                });
                lastUpdatedElement.textContent = `Last updated: ${timeString}`;
            }

            // Function to show error message
            function showError(message) {
                lastUpdatedElement.textContent = `Error: ${message}`;
            }

            // Function to get weather icon
            function getWeatherIcon(weatherMain) {
                const iconMap = {
                    "Clear": "fas fa-sun",
                    "Clouds": "fas fa-cloud",
                    "Rain": "fas fa-cloud-rain",
                    "Drizzle": "fas fa-cloud-rain",
                    "Thunderstorm": "fas fa-bolt",
                    "Snow": "fas fa-snowflake",
                    "Mist": "fas fa-smog",
                    "Smoke": "fas fa-smog",
                    "Haze": "fas fa-smog",
                    "Dust": "fas fa-smog",
                    "Fog": "fas fa-smog",
                    "Sand": "fas fa-smog",
                    "Ash": "fas fa-smog",
                    "Squall": "fas fa-wind",
                    "Tornado": "fas fa-tornado"
                };
                return iconMap[weatherMain] || "fas fa-cloud";
            }

            // Function to get weather type description
            function getWeatherTypeDescription(weatherType) {
                const descriptions = {
                    "storm": "Thunderstorm warning in effect",
                    "rain": "Rainfall advisory",
                    "high_wind": "High wind warning for coastal areas",
                    "heavy_rain": "Heavy rainfall alert",
                    "extreme_temp": "Extreme temperature conditions",
                    "normal": "Normal weather conditions"
                };
                return descriptions[weatherType] || "Weather monitoring active";
            }

            // Function to get marker color based on severity
            function getMarkerColor(severity) {
                switch(severity) {
                    case 'high': return [255, 0, 0]; // Red
                    case 'medium': return [255, 204, 0]; // Yellow
                    case 'low': return [0, 204, 0]; // Green
                    default: return [29, 161, 242]; // Blue
                }
            }

            // Function to update map markers with Esri
            function updateMapMarkers() {
                if (!graphicsLayer) return;
                
                // Clear existing markers
                graphicsLayer.removeAll();
                
                // Filter data based on current filter and search
                const filteredData = currentWeatherData.filter(weather => {
                    // Apply severity filter
                    if (currentFilter !== 'all' && weather.severity !== currentFilter) {
                        return false;
                    }
                    
                    // Apply search filter
                    if (currentSearch && !weather.location.toLowerCase().includes(currentSearch.toLowerCase()) && 
                        !weather.city.toLowerCase().includes(currentSearch.toLowerCase())) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Load Esri modules and create markers
                require(["esri/Graphic", "esri/geometry/Point", "esri/symbols/SimpleMarkerSymbol"], 
                function(Graphic, Point, SimpleMarkerSymbol) {
                    
                    // Add markers for filtered data
                    filteredData.forEach(weather => {
                        const markerColor = getMarkerColor(weather.severity);
                        
                        // Create a point for the location
                        const point = new Point({
                            longitude: weather.lon,
                            latitude: weather.lat
                        });
                        
                        // Create a symbol for the point
                        const markerSymbol = new SimpleMarkerSymbol({
                            color: markerColor,
                            size: "12px",
                            outline: {
                                color: [255, 255, 255],
                                width: 2
                            }
                        });
                        
                        // Create attributes for the graphic
                        const attributes = {
                            type: "weather",
                            city: weather.city,
                            region: weather.region,
                            severity: weather.severity,
                            temperature: weather.temperature,
                            weatherDescription: weather.weatherDescription,
                            content: weather.content,
                            humidity: weather.humidity,
                            windSpeed: weather.windSpeed,
                            timestamp: weather.timestamp,
                            isLive: weather.isLive,
                            weatherIcon: getWeatherIcon(weather.weatherMain),
                            weatherTypeDesc: getWeatherTypeDescription(weather.weatherType)
                        };
                        
                        // Create the graphic
                        const graphic = new Graphic({
                            geometry: point,
                            symbol: markerSymbol,
                            attributes: attributes
                        });
                        
                        // Add the graphic to the layer
                        graphicsLayer.add(graphic);
                    });
                    
                    // If no markers after filtering, show a message
                    if (filteredData.length === 0) {
                        // Create a point for the center of India
                        const point = new Point({
                            longitude: 78.9629,
                            latitude: 20.5937
                        });
                        
                        // Create a symbol for the point
                        const markerSymbol = new SimpleMarkerSymbol({
                            color: [100, 100, 100],
                            size: "8px"
                        });
                        
                        // Create the graphic
                        const graphic = new Graphic({
                            geometry: point,
                            symbol: markerSymbol,
                            attributes: {
                                type: "message",
                                city: "No data found",
                                content: "No weather data found matching your criteria."
                            }
                        });
                        
                        // Add the graphic to the layer
                        graphicsLayer.add(graphic);
                    }
                });
            }

            // Function to show info panel at bottom left
            function showInfoPanel(attributes) {
                if (!attributes || attributes.type !== "weather") return;
                
                // Update info panel content
                document.getElementById('infoCity').textContent = attributes.city;
                document.getElementById('infoSeverity').textContent = attributes.severity.toUpperCase();
                document.getElementById('infoSeverity').className = `text-xs font-bold px-2 py-1 rounded severity-${attributes.severity}`;
                document.getElementById('infoIcon').innerHTML = `<i class="${attributes.weatherIcon}"></i>`;
                document.getElementById('infoTemp').textContent = `${attributes.temperature}°C`;
                document.getElementById('infoDesc').textContent = attributes.weatherDescription;
                document.getElementById('infoContent').textContent = attributes.content;
                document.getElementById('infoHumidity').textContent = `Humidity: ${attributes.humidity}%`;
                document.getElementById('infoWind').textContent = `Wind: ${attributes.windSpeed} m/s`;
                document.getElementById('infoRegion').textContent = attributes.region;
                document.getElementById('infoTime').textContent = attributes.timestamp;
                document.getElementById('infoStatus').innerHTML = attributes.isLive ? 
                    '<i class="fas fa-satellite-dish text-green-500 mr-1"></i> Live Data' : 
                    '<i class="fas fa-database text-yellow-500 mr-1"></i> Cached Data';
                
                // Show the panel
                infoPanel.classList.remove('hidden');
            }

            // Function to hide info panel
            function hideInfoPanel() {
                infoPanel.classList.add('hidden');
                hoveredGraphic = null;
            }

            // Event listeners
            filterButton.addEventListener('click', () => {
                filterDropdown.classList.toggle('hidden');
            });

            // Filter option click handlers
            filterOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove active class from all options
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    // Add active class to clicked option
                    option.classList.add('active');
                    // Update current filter
                    currentFilter = option.getAttribute('data-filter');
                    // Update map markers
                    updateMapMarkers();
                    // Close dropdown
                    filterDropdown.classList.add('hidden');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (event) => {
                if (!filterButton.contains(event.target) && !filterDropdown.contains(event.target)) {
                    filterDropdown.classList.add('hidden');
                }
            });

            // Event listener for search
            searchHazardsInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                updateMapMarkers();
            });

            // Event listener for refresh
            refreshWeatherBtn.addEventListener('click', () => {
                fetchWeatherData();
                
                // Visual feedback
                refreshWeatherBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Refreshing...';
                refreshWeatherBtn.disabled = true;
                
                setTimeout(() => {
                    refreshWeatherBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Refresh Weather';
                    refreshWeatherBtn.disabled = false;
                }, 2000);
            });

            // Auto-refresh every 5 minutes
            setInterval(fetchWeatherData, 5 * 60 * 1000);

            // Initialize the map and fetch data
            initializeMap();
            fetchWeatherData();

            // Enhanced smooth scrolling for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        // Calculate offset (adjust 80 based on your header height)
                        const offsetTop = targetElement.offsetTop - 80;
                        
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                        
                        // Update URL without jumping
                        history.pushState(null, null, targetId);
                    }
                });
            });
        });
        // Add event delegation for the floating button
document.addEventListener('click', function(e) {
    // Check if settings toggle was clicked
    if (e.target.closest('#settingsToggle') || e.target.id === 'settingsToggle') {
        e.preventDefault();
        e.stopPropagation();
        console.log('Settings toggle clicked via delegation');
        
        const settingsPanel = document.getElementById('settingsPanel');
        if (settingsPanel) {
            settingsPanel.classList.toggle('active');
            console.log('Panel toggled via delegation');
        }
    }
    
    // Check if close button was clicked
    if (e.target.closest('#closeSettings') || e.target.id === 'closeSettings') {
        const settingsPanel = document.getElementById('settingsPanel');
        if (settingsPanel) {
            settingsPanel.classList.remove('active');
        }
    }
});

// Also check on page load and after a delay
setTimeout(() => {
    console.log('Checking for button elements after delay...');
    const toggle = document.getElementById('settingsToggle');
    const panel = document.getElementById('settingsPanel');
    
    if (toggle) {
        console.log('Found toggle, adding direct listener');
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Direct listener fired!');
            if (panel) {
                panel.classList.toggle('active');
            }
        });
    }
}, 3000);
    </script>
</body>
</html>